--
-- Created by IntelliJ IDEA.
-- User: Administrator
-- Date: 2017/4/8
-- Time: 8:10
-- To change this template use File | Settings | File Templates.
--

local patterns = {[[
listesc
福州福威镖局押镖任务列表：
任务序号  任务目的地               任务发布时间   任务状态 认领玩家
=============================================================================
16975     临安府江南钱庄                    510秒   已认领 gengfeng
16976     嘉兴钱庄                          510秒   已认领 akking
16977     归云庄太湖街                      510秒   待认领 0
16984     牙山小荒地                        353秒   待认领 0
16985     泉州当铺                          353秒   已完成 atomy
16986     嘉兴陆家庄大厅                    353秒   待认领 0
=============================================================================
使用命令【getesc 任务序号】来认领押镖任务。

getesc 34854
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到泉州当铺王福贵那里，他已经派了个伙计名叫令狐轩梅到泉州码头附近接你，把镖车送到他那里就行了。

gan che to west
西大街
你赶着镖车驶了过来。
镖车隆隆驶了过来。
>
gan che to west
镖车还没有跟上来呢,走慢点.

gan che to north
劫匪伸手一拦道：“想跑？没那么容易！”

你累了个半死，终于把镖运到了地头。

令狐轩梅对你说道：“终于到了！小兄弟辛苦了！”

围上来几个伙计将镖车拉了进去。

ask lin about finish
你向林震南打听有关『finish』的消息。
你一共被奖励了：
三百零四点经验；
一百十点潜能；
六十七点江湖声望。
林震南吩咐了旁边的镖头几句，转头对你道：「辛苦了，有几两银子略表心意，已经吩咐人存入你的钱庄账户。」
林震南拍了拍撸啊的头，说道：「好孩子，乖。」
林震南说道：「小兄弟果然是栋梁之才！」

getesc 34853
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到苏州聚宝斋孙剥皮那里，他已经派了个伙计名叫樊柏慕到沧浪亭附近接你，把镖车送到他那里就行了。

你赶着镖车驶了过来。
镖车隆隆驶了过来。
> 你累了个半死，终于把镖运到了地头。

樊柏慕对你说道：“终于到了！小兄弟辛苦了！”

围上来几个伙计将镖车拉了进去。

getesc 34882
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到泉州当铺王福贵那里，他已经派了个伙计名叫包云永到南门附近接你，把镖车送到他那里就行了。

gan che to northwest
这个方向过不去。

listesc
福州福威镖局押镖任务列表：
任务序号  任务目的地               任务发布时间   任务状态 认领玩家
=============================================================================
34882     泉州当铺                          471秒   已完成 luar
34883     镇江飞龙镖局                      471秒   已认领 crafting
34884     嘉兴陆家庄大厅                    471秒   待认领 0
34891     岳王墓墓前广场                    154秒   待认领 0
34892     泉州当铺                          154秒   待认领 0
34893     牙山小荒地                        154秒   待认领 0
=============================================================================
使用命令【getesc 任务序号】来认领押镖任务。

getesc 34893
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到牙山小荒地黄毛鬼那里，他已经派了个伙计名叫樊慕郎到破屋附近接你，把镖车送到他那里就行了。

劫匪突然从暗处跳了出来，阴笑道：“红货和人命都留下来吧！。”

getesc 34901
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到镇江飞龙镖局张经那里，他已经派了个伙计名叫余坚七到土路附近接你，把镖车送到他那里就行了。

劫匪伸手一拦道：“想跑？没那么容易！”

劫匪趁你不注意，推着镖车就跑，你赶紧追了上去。

你赶着镖车驶了过来。
镖车隆隆驶了过来。
> 你累了个半死，终于把镖运到了地头。

余坚七对你说道：“终于到了！小兄弟辛苦了！”

围上来几个伙计将镖车拉了进去。
劫匪突然从暗处跳了出来，阴笑道：“红货和人命都留下来吧！。”
你在攻击中不断积蓄攻势。(气势：4%)
劫匪正盯著你的一举一动，随时准备发动攻势。

getesc 34922
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到岳王墓墓前广场包打听那里，他已经派了个伙计名叫侯征永到墓边小道附近接你，把镖车送到他那里就行了。

getesc 34916
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到归云庄太湖街商人那里，他已经派了个伙计名叫阮明到太湖街附近接你，把镖车送到他那里就行了。

劫匪叫道：点子扎手，扯呼！

劫匪个起纵遁入暗里不见了。

> 劫匪突然从暗处跳了出来，阴笑道：“红货和人命都留下来吧！。”

忽然一阵刺骨的奇寒袭来，你中的星宿毒掌毒发作了！

gan che to northwest
你还是先把对手解决了再说吧！

斜刺里冲出来小偷,猛地对你痛下杀手！
趟子手大呼：有人劫镖阿，快护镖，快快！

gan che to east
你现在正忙着哩。

getesc 34923
你所领的任务在任务列表中并不存在。
认领任务失败，请选择其他任务。

getesc 34934
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到嘉兴陆家庄大厅陆立鼎那里，他已经派了个伙计名叫左少康到大厅附近接你，把镖车送到他那里就行了。

getesc 47912
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到临安府江南钱庄金乞儿那里，他已经派了个伙计名叫闻火涛到杂货铺附近接你，把镖车送到他那里就行了。

getesc 47955
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到嘉兴陆家庄大厅陆立鼎那里，他已经派了个伙计名叫曹琨到大厅附近接你，把镖车送到他那里就行了。

getesc 47997
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到南昌飞虎镖局楚大业那里，他已经派了个伙计名叫安司卿到城中心附近接你，把镖车送到他那里就行了。

getesc 48026
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到南昌飞虎镖局楚大业那里，他已经派了个伙计名叫余捷到偃月楼附近接你，把镖车送到他那里就行了。

    「店铺伙计」阮威龙(Ruan weilong)

getesc 48027
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到岳王墓墓前广场包打听那里，他已经派了个伙计名叫阮威龙到墓前广场附近接你，把镖车送到他那里就行了。

getesc 48069
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到镇江飞龙镖局张经那里，他已经派了个伙计名叫呼延波亦到北大街附近接你，把镖车送到他那里就行了。

getesc 48118
林震南点了点头。
几个伙计将镖推了出来。
撸啊把这批红货送到泉州当铺王福贵那里，他已经派了个伙计名叫高玄生到山路附近接你，把镖车送到他那里就行了。

你还是先把对手解决了再说吧！

zhao
一个伙计挖着鼻屎走了出来，道：你找我啥事？

ask tam about yao
你向唐进打听有关『yao』的消息。
唐进说道：你在说外国话吧？我不会，你最好带个翻译来。

ask tam about yao
你向唐进打听有关『yao』的消息。
唐进把一包财物砸向你，一转眼不见了。

getesc 48916
你上次运镖太辛苦了，下去休息休息吧。
>
getesc 48917
你正忙着呢！
>

（只听见「啪」地一声，你手中的青锋剑已经断为两截！）

（宋悦蓓的钢杖和你的青锋剑重重交击在一起，发出「铛」地一声。）

]]}

local helper = require "pkuxkx.helper"
local FSM = require "pkuxkx.FSM"
local travel = require "pkuxkx.travel"
local status = require "pkuxkx.status"

local define_fsm = function()
  local prototype = FSM.inheritedMeta()

  local States = {
    stop = "stop",  -- 终止状态，与jobs模块整合，提供waitDone触发
    prepare = "prepare",  -- 准备任务，查看任务
    prefetch = "prefetch",  -- 预先前往查找目的地
    transfer = "transfer",  -- 运输中
    lost = "lost",  -- 迷路中（很大可能被强盗推至相邻房间）
    submit = "submit",  -- 提交
    mixin = "mixin",  -- 密信
  }
  local Events = {
    ALIAS_START = "^hubiao\\s+start\\s*$",
    ALIAS_STOP = "^hubiao\\s+stop\\s*$",
    ALIAS_DEBUG = "%hubiao\\s+debug\\s+(on|off)\\s*$",
    STOP = "stop",  -- 任何状态下停止
    START = "start",  -- stop -> prepare
    ACCEPT_SUCCESS = "accept_success",  -- prepare -> prefetch
    ACCEPT_FAIL = "accept_fail",  -- prepare -> prepare
    NEXT_PREFETCH = "next_prefetch",  -- prefetch -> prefetch
    PREFETCH_SUCCESS = "prefetch_success",  -- prefetch -> transfer
  }
  local REGEXP = {
    JOB_INFO = "^(\\d+)\\s+(.*?)\\s+(\\d+)秒\\s+(.*?)\\s+(.*)$",
    ACCEPT_INFO = "^.*把这批红货送到(.*?)那里，他已经派了个伙计名叫(.*?)到(.*?)附近接你，把镖车送到他那里就行了。$",
    ACCEPT_FAIL = "^[ >]*认领任务失败，请选择其他任务。$",
  }

  -- 福州福威镖局
  local StartRoomId = 26
  local PrefetchDepth = 5

  function prototype:FSM()
    local obj = FSM:new()
    setmetatable(obj, self or prototype)
    obj:postConstruct()
    return obj
  end

  function prototype:postConstruct()
    self:initStates()
    self:initTransitions()
    self:initTriggers()
    self:initAliases()
    self:setState(States.stop)
    self.maxRound = 8
    self.round = 0

    -- precondition
    self.precondition = {
      jing = 0.96,
      qi = 0.96,
      jingli = 1,
      neili = 1.8
    }
    -- special variable
    self.playerName = "撸啊"
    self.playerId = "luar"
  end

  function prototype:disableAllTriggers()

  end

  function prototype:initStates()
    self:addState {
      state = States.stop,
      enter = function()
        self:disableAllTriggers()
        self:removeTriggerGroups("hubiao_prefetch_traverse")
        SendNoEcho("set jobs done")  -- 为jobs提供结束触发
      end,
      exit = function() end
    }
    self:addState {
      state = States.prepare,
      enter = function()
        helper.enableTriggerGroups("hubiao_info_start", "hubiao_accept_start")
      end,
      exit = function()
        helper.disableTriggerGroups("hubiao_info_start", "hubiao_info_done",
          "hubiao_accept_start", "hubiao_accept_done")
      end
    }
    self:addState {
      state = States.prefetch,
      enter = function() end,
      exit = function() end
    }
    self:addState {
      state = States.transfer,
      enter = function() end,
      exit = function() end
    }
    self:addState {
      state = States.submit,
      enter = function() end,
      exit = function() end
    }
  end

  function prototype:initTransitions()
    -- transition from state<stop>
    self:addTransition {
      oldState = States.stop,
      newState = States.prepare,
      event = Events.START,
      action = function()
        return self:doPrepare()
      end
    }
    self:addTransitionToStop(States.stop)
    -- transition from state<prepare>
    self:addTransition {
      oldState = States.prepare,
      newState = States.prepare,
      event = Events.ACCEPT_FAIL,
      action = function()
        self:debug("等待3秒后重新接任务")
        wait.time(3)
        return self:doPrepare()
      end
    }
    self:addTransition {
      oldState = States.prepare,
      newState = States.prefetch,
      event = Events.ACCEPT_SUCCESS,
      action = function()
        self:debug("等待3秒后开始预取")
        wait.time(3)
        return self:doConfirmSearhRooms()
      end
    }
    self:addTransition {
      oldState = States.prepare,
      newState = States.stop,
      event = Events.NO_JOB_AVAILABLE,
      action = function()
        self:debug("目前无可用任务，等待2秒后结束")
        wait.time(2)
        return self:fire(Events.STOP)
      end
    }
    self:addTransitionToStop(States.prepare)
    -- transition from state<prefetch>
    self:addTransition {
      oldState = States.prefetch,
      newState = States.prefetch,
      event = Events.NEXT_PREFETCH,
      action = function()
        return self:doPrefetch()
      end
    }
    self:addTransitionToStop(States.prefetch)
  end

  function prototype:initTriggers()
    helper.removeTriggerGroups("hubiao_info_start", "hubiao_info_done")
    -- info
    helper.addTriggerSettingsPair {
      group = "hubiao",
      start = "info_start",
      done = "info_done"
    }
    helper.addTrigger {
      group = "hubiao_info_done",
      regexp = REGEXP.JOB_INFO,
      response = function(name, line, wildcards)
        self:debug("JOB_INFO triggered")
        local jobId = wildcards[1]
        local jobLocation = wildcards[2]
        local jobRemainedTime = wildcards[3]
        local jobStatus = wildcards[4]
        local jobPlayer = wildcards[5]
        if jobStatus == "待认领" then
          table.insert(self.jobs, {id = jobId, location = jobLocation})
        end
      end
    }
    -- accept
    helper.addTriggerSettingsPair {
      group = "hubiao",
      start = "accept_start",
      done = "accept_done"
    }
    helper.addTrigger {
      group = "hubiao_accept_done",
      regexp = REGEXP.ACCEPT_FAIL,
      response = function()
        self:debug("ACCEPT_FAIL triggered")
      end
    }
    helper.addTrigger {
      group = "hubiao_accept_done",
      regexp = REGEXP.ACCEPT_INFO,
      response = function(name, line, wildcards)
        self.acceptSuccess = true
        self.employer = wildcards[1]
        self.dudeName = wildcards[2]
        self.searchRoomName = wildcards[3]
      end
    }
  end

  function prototype:initAliases()
    helper.removeAliasGroups("hubiao")
    helper.addAlias {
      group = "hubiao",
      regexp = REGEXP.ALIAS_START,
      response = function()
        return self:fire(Events.START)
      end
    }
    helper.addAlias {
      group = "hubiao",
      regexp = REGEXP.ALIAS_STOP,
      response = function()
        return self:fire(Events.STOP)
      end
    }
    helper.addAlias {
      group = "hubiao",
      regexp = REGEXP.ALIAS_DEBUG,
      response = function(name, line, wildcards)
        local cmd = wildcards[1]
        if cmd == "on" then
          self:debugOn()
        else
          self:debugOff()
        end
      end
    }
  end

  function prototype:addTransitionToStop(fromState)
    self:addTransition {
      oldState = fromState,
      newState = States.stop,
      event = Events.STOP,
      action = function()
        print("停止 - 当前状态", self.currState)
      end
    }
  end

  function prototype:doGetJob()
    self.jobs = {}
    SendNoEcho("set hubiao info_start")
    SendNoEcho("listesc")
    SendNoEcho("set hubiao info_done")
    -- 等待两秒接任务
    wait.time(2)
    helper.assureNotBusy()
    if #(self.jobs) > 0 then
      return self:doAcceptJob()
    else
      return self:fire(Events.NO_JOB_AVAILABLE)
    end
  end

  function prototype:doAcceptJob()
    -- 设置当前任务
    local _, job = next(self.jobs)
    self.currJob = job
    self.acceptSuccess = false
    self.employer = nil
    self.dudeName = nil
    self.searchRoomName = nil
    SendNoEcho("set hubiao accept_start")
    SendNoEcho("getesc " .. self.currJob.id)
    SendNoEcho("set hubiao accept_done")
    helper.assureNotBusy()
    if self.acceptSuccess then
      return self:fire(Events.ACCEPT_SUCCESS)
    else
      return self:fire(Events.ACCEPT_FAIL)
    end
  end

  function prototype:doConfirmSearhRooms()
    local targets = travel:getMatchedRooms {
      fullname = self.currJob.location
    }
    if #(targets) == 0 then
      self:debug("运镖区域不可达，等待2秒后结束")
      wait.time(2)
      return self:fire(Events.STOP)
    else
      local searchRooms = travel:getMatchedRooms {
        zone = targets[1].zone,
        name = self.searchRoomName,
      }
      if #(searchRooms) == 0 then
        self:debug("伙计所在地点不可达，无法执行预取，等待2秒后结束")
        wait.time(2)
        return self:fire(Events.STOP)
      else
        self.searchedRoomIds = {}
        self.searchRooms = searchRooms
        return self:fire(Events.NEXT_PREFETCH)
      end
    end
  end

  function prototype:doPrefetch()
    if #(self.searchRooms) > 0 then
      local searchStartRoom = table.remove(self.searchRooms)
      if self.searchedRoomIds[searchStartRoom.id] then
        self:debug("房间已搜索过，跳过", searchStartRoom.id)
        return self:doPrefetch()
      else
        helper.assureNotBusy()
        travel:walkto(searchStartRoom.id)
        travel:waitUntilArrived()
        self:debug("到达搜索起始地点", searchStartRoom.id)
        self:debug("开始遍历寻找，深度为", PrefetchDepth)

        self.targetRoomId = nil
        helper.addTrigger {
          group = "hubiao_prefetch_traverse",
          regexp = "^\\s*「店铺伙计」" .. self.dudeName .. "\\(.*?\\)$",
          response = function()
            --找到伙计，则设置目标地点为当前房间编号
            self.targetRoomId = travel:traverseRoomId
          end
        }
        local onStep = function()
          return self.targetRoomId ~= nil  -- 停止条件，找到伙计
        end
        local onArrive = function()
          helper.removeTriggerGroups("hubiao_prefetch_traverse")
          if self.targetRoomId then
            self:debug("遍历结束，已经发现伙计，并确定目标房间：", self.targetRoomId)
            return self:fire(Events.PREFETCH_SUCCESS)
          else
            self:debug("没有发现伙计，尝试下一个地点")
            wait.time(1)
            return self:fire(Events.NEXT_PREFETCH)
          end
        end
        return travel:traverseNearby(PrefetchDepth, onStep, onArrive)
      end
    else
      self:debug("没有更多的搜索房间，预取失败，放弃该任务")
      wait.time(2)
      return self:doCancel()
    end
  end

  function prototype:doCancel()
    helper.assureNotBusy()
    travel:walkto(StartRoomId)
    travel:waitUntilArrived()
    helper.assureNotBusy()
    SendNoEcho("ask lin about fail")
    return self:fire(Events.STOP)
  end

  return prototype
end
return define_fsm():FSM()

